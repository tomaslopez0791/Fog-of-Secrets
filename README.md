# Fog of Secrets

Fog of Secrets is a fully homomorphic encryption (FHE) powered strategy game that showcases how private and public on-chain data can coexist within a single interactive experience. Players spawn on a 10×10 grid that is split into two domains: encrypted coordinates (`id 1–50`) and public coordinates (`id 51–100`). If a player lands on the encrypted half of the map, only that player can decrypt their exact location; if the spawn point is in the public zone, Zama’s public FHE key reveals the location to everyone. The front end visualizes all known positions, hiding encrypted tiles while highlighting public discoveries.

The project combines Zama’s FHEVM smart contracts with a React + Vite interface and an off-chain relayer to create an end-to-end demo of privacy-preserving gameplay on Ethereum.

---

## Challenges Addressed

- **Privacy vs. Transparency**: Traditional blockchain games struggle to hide player information without off-chain trust. Fog of Secrets keeps sensitive positions encrypted on-chain while still making public moves visible.
- **FHE Integration Complexity**: The repository packages Zama’s FHEVM tooling, relayer, and oracle contracts so developers can focus on gameplay logic instead of low-level cryptography.
- **Developer Onboarding**: Detailed scripts, documentation pointers, and a ready-to-run front end shorten the time from cloning the repo to deploying on Sepolia.
- **Deterministic Gameplay Auditing**: By separating encrypted and public zones, auditors can verify public outcomes without compromising private data.

---

## Key Advantages

- **On-chain Privacy**: Coordinates in the encrypted zone remain unintelligible to everyone except the owning player; even the contract avoids leaking `msg.sender` inside view calls.
- **Hybrid Visibility**: Public tiles offer shared map knowledge, creating interesting tension between exploration and secrecy.
- **Full-Stack Template**: Contracts, deployment scripts, Hardhat tasks, tests, and the React application ship together with consistent tooling and linting.
- **Production-Ready Deployment Flow**: `.env` driven configuration uses `INFURA_API_KEY` and `PRIVATE_KEY` for Sepolia deployments without relying on mnemonics.
- **Verified ABIs & Artifacts**: Front end consumes the ABI generated by Hardhat from `deployments/sepolia`, ensuring perfect parity with deployed contracts.
- **Ecosystem Alignment**: Adheres to Zama documentation (`docs/zama_llm.md`, `docs/zama_doc_relayer.md`) and uses ethers for writes plus viem for reads, matching recommended patterns.

---

## Gameplay & User Experience

1. **Randomized Spawn**: Starting a session calls the contract to allocate a random tile `id` between 1 and 100.
2. **Encryption Rules**:
   - `1–50`: Stored with FHE, only the player can retrieve a decrypted location.
   - `51–100`: Publicly decrypted through Zama’s public key.
3. **Map Rendering**: The React front end queries contract state via viem. Public tiles display coordinates; encrypted tiles are masked but counted so players sense hidden activity.
4. **Interaction Model**: Write operations use ethers to leverage signer-based transactions, while reads stay gasless through viem’s public client.
5. **Relayer Integration**: Zama’s relayer SDK enables the front end to request decryption proofs without touching local storage or localhost networks.

---

## Architecture Overview

- **Smart Contracts (`contracts/`)**
  - `FogOfSecretsGame.sol` orchestrates spawning, encryption handling, and location queries.
  - Prohibits reading `msg.sender` within view methods, aligning with audit guidance.
- **Hardhat Environment**
  - Managed via `hardhat.config.ts`, `deploy/`, `tasks/`, and `test/`.
  - Uses `@fhevm/hardhat-plugin` for FHE tooling, plus TypeChain for typed bindings.
- **Frontend (`src/`)**
  - A Vite-powered React app located under `./src`, with its own `package.json`.
  - Consumes deployment artifacts from `deployments/sepolia` and strictly avoids Tailwind, environment variables, localStorage, and hooks modifications.
- **Docs & References**
  - `docs/zama_llm.md` for contract usage.
  - `docs/zama_doc_relayer.md` for relayer integration details.

---

## Technology Stack

- **Blockchain & FHE**: Solidity, Hardhat, Zama FHEVM, `@zama-fhe/oracle-solidity`
- **Tooling**: TypeScript, TypeChain, Hardhat Deploy, Hardhat Gas Reporter, Solhint, ESLint, Prettier
- **Frontend**: React, Vite, viem (reads), ethers (writes), RainbowKit / wallet connectors
- **Relayer & SDKs**: `@zama-fhe/relayer-sdk`, `encrypted-types`
- **Testing**: Hardhat Network Helpers, Chai, Mocha, Solidity Coverage

---

## Repository Layout

```
Fog-of-Secrets/
├── contracts/              # FHE-enabled smart contracts
├── deploy/                 # Hardhat deployment scripts
├── deployments/            # Generated artifacts per network (e.g., sepolia ABI)
├── docs/                   # Project-specific guides (Zama LLM & relayer)
├── src/                    # Frontend (React + Vite) project root
│   ├── package.json        # Frontend dependencies & scripts
│   └── src/                # React application source
├── tasks/                  # Hardhat task definitions
├── test/                   # Contract tests
├── hardhat.config.ts       # Hardhat configuration
├── scripts/                # (Add if needed for future automation)
└── README.md               # Project documentation (this file)
```

> **Note**: Do not remove `deployments/sepolia` artifacts—front-end ABI imports depend on them.

---

## Getting Started

### 1. Prerequisites

- Node.js `>= 20`
- npm `>= 7`
- Access to an Ethereum endpoint (Infura recommended)
- A funded Sepolia account for deployment

### 2. Install Contract Dependencies

```bash
npm install
```

### 3. Configure Environment

Create a `.env` file in the project root:

```env
INFURA_API_KEY=<your-infura-api-key>
PRIVATE_KEY=<deployer-private-key>
ETHERSCAN_API_KEY=<optional-for-verification>
```

- The deployment flow relies on `process.env.INFURA_API_KEY` and `process.env.PRIVATE_KEY`.
- **Do not** use a mnemonic; the scripts expect a single private key.

### 4. Compile & Test Contracts

```bash
npm run compile
npm run test
```

Additional utilities:

```bash
npm run lint          # Solhint + ESLint + Prettier check
npm run coverage      # Solidity coverage
npm run clean         # Reset build artifacts
```

### 5. Run a Local FHEVM-Compatible Node

```bash
npx hardhat node
```

In a separate terminal, deploy to the local network:

```bash
npx hardhat deploy --network localhost
```

### 6. Deploy to Sepolia

```bash
npx hardhat deploy --network sepolia
```

After deployment, the ABI and address are written to `deployments/sepolia`. Use `npx hardhat verify --network sepolia <CONTRACT_ADDRESS>` if you want Etherscan verification.

### 7. Start the Frontend

```bash
cd src          # Enter the React project
npm install     # Install frontend dependencies
npm run dev     # Launch Vite dev server (uses configured network)
```

- The front end reads live contract state; ensure the contract is deployed on the target network before launching.
- All read calls rely on viem with public RPCs; write interactions use ethers with the connected wallet.

---

## Development Guidelines

- **Artifacts**: Copy ABI files exclusively from Hardhat outputs in `deployments/sepolia`.
- **UI Constraints**: No Tailwind, no `.json` config imports inside React, no use of `localStorage`, no localhost RPC endpoints.
- **Hooks**: The existing hooks folder must remain unchanged; integrate new logic through components or services.
- **Environment Variables**: The front end is configured without runtime environment variables; network selection is handled in code.
- **Security**: Avoid referencing `msg.sender` inside any `view` functions to maintain FHE secrecy guarantees.

---

## Future Roadmap

- **Expanded Game Mechanics**: Introduce movement, fog-of-war exploration rewards, and cooperative objectives.
- **Encrypted Events**: Leverage homomorphic computations to reveal aggregate statistics without exposing individual positions.
- **Cross-Network Deployments**: Package scripts for additional testnets and mainnet once FHEVM support broadens.
- **Analytics Dashboard**: Build read-only dashboards showing public map evolution while preserving encrypted secrecy.
- **Automated Frontend Deployment**: Add CI workflows for static hosting (e.g., Netlify/Vercel) tied to Sepolia releases.
- **In-Game Economy**: Design encrypted resource gathering and trading that respects privacy constraints.

---

## Additional Resources

- Zama FHEVM documentation: <https://docs.zama.ai/fhevm>
- Hardhat + FHEVM quick start: <https://docs.zama.ai/protocol/solidity-guides/getting-started/quick-start-tutorial>
- Project-specific notes:
  - `docs/zama_llm.md` – Smart contract integration details
  - `docs/zama_doc_relayer.md` – Frontend relayer usage guide

---

## License

Fog of Secrets is released under the [BSD-3-Clause-Clear License](LICENSE).

---

Built with privacy-first mechanics on Ethereum using Zama’s FHEVM.
